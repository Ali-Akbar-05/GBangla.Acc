@using Microsoft.AspNetCore.Antiforgery
@inject IAntiforgery antiForgeryToken
@model Application.ViewModel.GBAcc.Setups.CBMBankAccount.Create.CBMBankAccountVM
@{
    var token = antiForgeryToken.GetAndStoreTokens(Context);
    ViewData[PageInfo.PageHeader] = "Bank Account";
    ViewData[PageInfo.PageTitle] = "Bank Account";
}

<div class="row ajt-control">
    <form id="frmBankAccount" class="col-sm-12 col-md-12">
        <div class="col-sm-12 col-md-12">
            <div class="card card-success text-sm">
                <div class="card-header text-xs">
                    <h6 class="card-title">
                        Bank Account Setup
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row m-0">
                        <div class="col-sm-4 col-md-4 col-lg-4">
                            <div class="form-group">
                                <label class="col-form-label-sm m-0 required" asp-for="AccTypeID"></label>
                                <select asp-for="AccTypeID" class="form-control form-control-sm" asp-items="Model.DDLAccountType"></select>
                                <span asp-validation-for="AccTypeID" class="span-form-validation text-danger"></span>
                            </div>
                        </div>
                        <div class="col-sm-4 col-md-4 col-lg-4">
                            <div class="form-group">
                                <label class="col-form-label-sm m-0 required" asp-for="BankID"></label>
                                <select asp-for="BankID" class="form-control form-control-sm" asp-items="Model.DDLBank"></select>
                                <span asp-validation-for="BankID" class="span-form-validation text-danger"></span>
                            </div>
                        </div>
                        <div class="col-sm-4 col-md-4 col-lg-4">
                            <div class="form-group">
                                <label class="col-form-label-sm m-0 required" asp-for="BranchID"></label>
                                <select asp-for="BranchID" class="form-control form-control-sm" asp-items="Model.DDLBranch"></select>
                                <span asp-validation-for="BranchID" class="span-form-validation text-danger"></span>
                            </div>
                        </div>


                    </div>
                    <div class="row m-0">
                        <div class="col-sm-4 col-md-4 col-lg-4">
                            <div class="form-group">
                                <label class="col-form-label-sm m-0 required" asp-for="CurrencyID"></label>
                                <select asp-for="CurrencyID" class="form-control form-control-sm" asp-items="Model.DDLCurrency"></select>
                                <span asp-validation-for="CurrencyID" class="span-form-validation text-danger"></span>
                            </div>
                        </div>
                        <div class="col-sm-4 col-md-4 col-lg-4">
                            <div class="form-group">
                                <label class="col-form-label-sm m-0 required" asp-for="AccountNumber"></label>
                                <input type="text" class="form-control form-control-sm " asp-for="AccountNumber" placeholder="Account Number" autocomplete="off">
                                <span asp-validation-for="AccountNumber" class="span-form-validation "></span>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="card card-success text-sm">
                <div class="card-header text-xs">
                    <h6 class="card-title">Relationship Manager </h6>
                </div>
                <div class="card-body">
                    <div class="row m-0">
                        <div class="col-sm-4 col-md-4 col-lg-4">
                            <div class="form-group">
                                <label class="col-form-label-sm m-0" asp-for="Name"></label>
                                <input type="text" class="form-control form-control-sm " asp-for="Name" placeholder="Name" autocomplete="off">
                                <span asp-validation-for="Name" class="span-form-validation"></span>
                            </div>
                        </div>
                        <div class="col-sm-4 col-md-4 col-lg-4">
                            <div class="form-group">
                                <label class="col-form-label-sm m-0" asp-for="Designation"></label>
                                <input type="text" class="form-control form-control-sm " asp-for="Designation" placeholder="Designation" autocomplete="off">
                                <span asp-validation-for="Designation" class="span-form-validation"></span>
                            </div>
                        </div>
                        <div class="col-sm-4 col-md-4 col-lg-4">
                            <div class="form-group">
                                <label class="col-form-label-sm m-0" asp-for="PhoneNumber"></label>
                                <input type="text" class="form-control form-control-sm " asp-for="PhoneNumber" placeholder="Phone Number" autocomplete="off">
                                <span asp-validation-for="PhoneNumber" class="span-form-validation"></span>
                            </div>
                        </div>

                    </div>

                    <div class="row m-0">
                        <div class="col-sm-4 col-md-4 col-lg-4">
                            <div class="form-group">
                                <label class="col-form-label-sm m-0" asp-for="FaxNumber"></label>
                                <input type="text" class="form-control form-control-sm " asp-for="FaxNumber" placeholder="Fax Number" autocomplete="off">
                                <span asp-validation-for="FaxNumber" class="span-form-validation "></span>
                            </div>
                        </div>
                        <div class="col-sm-4 col-md-4 col-lg-4">
                            <div class="form-group">
                                <label class="col-form-label-sm m-0" asp-for="Email"></label>
                                <input type="text" class="form-control form-control-sm " asp-for="Email" placeholder="Email" autocomplete="off">
                                <span asp-validation-for="Email" class="span-form-validation "></span>
                            </div>
                        </div>
                        <div class="col-sm-4 col-md-4 col-lg-4">
                            <div class="form-group">
                                <label class="col-form-label-sm m-0" asp-for="Comments"></label>
                                <input type="text" class="form-control form-control-sm " asp-for="Comments" placeholder="Comments" autocomplete="off">
                                <span asp-validation-for="Comments" class="span-form-validation "></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <div class="row m-0 text-center">
            <div class="col-sm-12 col-md-12 col-lg-12">
                <div class="form-group">
                    <input type="button" class="btn btn-sm btn-success" id="btnSave" value="Save">

                </div>
            </div>

        </div>
        <div class="row m-0">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <div id="grid">
                </div>
            </div>
        </div>
    </form>
</div>




@section scripts{ 
    <script type="text/javascript">
        $(function () {
            GetCBMBankAccountList();
        $('#BankID').change(function () {
            let bankID = RtnNumber($('#BankID').val());
            HttpRequest.DropDown('GET', '/Setups/CBMBankAccount/GetBranchListByBankID', { bankID: bankID }, 'BranchID')
        })

        $("#btnSave").click(function () {
            if ($('#frmBankAccount').valid()) {
                debugger
                let accTypeID = RtnNumber($("#AccTypeID").val());
               // let bankID = RtnNumber($("#BankID").val());
                let branchID = RtnNumber($("#BranchID").val());
                let currencyID = RtnNumber($("#CurrencyID").val());
                let accountNumber = $("#AccountNumber").val();
                let name = $("#Name").val();
                let designation = $("#Designation").val();
                let phoneNumber = $("#PhoneNumber").val();
                let faxNumber = $("#FaxNumber").val();
                let Email = $("#Email").val();
                let Comments = $("#Comments").val()
                var bankContactInfo = {
                    AccountID: 0,
                    ContactName: name,
                    Designation: designation,
                    Phone: phoneNumber,
                    Fax: faxNumber,
                    Email: Email,
                    Comments: Comments
                }

                var bankAccountObj = {
                   // BAccountID: bankID,
                    BAccountName: accountNumber,
                    TypeID: accTypeID,
                    CurrencyID: currencyID,
                    BranchID: branchID,
                    Limit: 0,
                    //LRemarks
                    BankContactInfo: bankContactInfo
                }
                if (bankAccountObj!=null) {
                    HttpRequest.Ajax("POST", '/Setups/CBMBankAccount/SaveBankAccount', { "cBMBankAccount": bankAccountObj, '@token.HeaderName': '@token.RequestToken' }, saveSuccess);
                }

            }

        })

    })

        function GetCBMBankAccountList() {

            var url = "/Setups/CBMBankAccount/GetBankAccountList";

            // var dataGridrow;
            var dataGrid = $("#grid").dxDataGrid({
                dataSource: DevExpress.data.AspNet.createStore({
                    key: "BAccountID",
                    loadUrl: url,
                }),

                remoteOperations: {
                    paging: true,
                    sorting: true,
                    filtering: true,
                },
                showColumnLines: false,
                showRowLines: true,
                showBorders: true,
                paging: {
                    pageSize: 10
                },
                pager: {
                    showInfo: true,
                    allowedPageSizes: [10, 20, 40, 100, 500],
                    showPageSizeSelector: true,
                },
                loadingIndicator: {
                    enabled: true
                },
                selection: { mode: 'single' },
                headerFilter: { visible: false, allowSearch: true },
                filterRow: { visible: false },
                wordWrapEnabled: true,
                columns: [
                    {
                        dataField: "BAccountID",
                        visible: false,
                    },
                    {
                        width: "5%",
                        caption: "SL",
                        alignment: 'center',
                        cellTemplate: function (cellElement, cellInfo) {
                            var index = dataGrid.pageIndex() * dataGrid.pageSize() + cellInfo.rowIndex + 1;
                            cellElement.text(index)
                        }

                    },


                    {

                        caption: "Account",
                        wordWrapEnabled: false,
                        alignment: 'center',
                        allowFiltering: false,
                        dataField: "AccountName",
                    },
                    {

                        caption: "Account Type",
                        wordWrapEnabled: false,
                        alignment: 'center',
                        allowFiltering: false,
                        dataField: "AccountType",

                    },
                    {

                        caption: "Bank",
                        wordWrapEnabled: false,
                        alignment: 'center',
                        allowFiltering: false,
                        dataField: "BankName",

                    },
                    {

                        caption: "Branch",
                        wordWrapEnabled: false,
                        alignment: 'center',
                        allowFiltering: false,
                        dataField: "BranchName",

                    },
                    //
                    {
                        width: "10%",
                        caption: "Action",
                        alignment: 'center',
                        headerCellTemplate: function (header, info) {
                            $('<div>').html(info.column.caption).css('font-weight', 'bold').appendTo(header);
                        },
                        cellTemplate: function (container, options) {

                            var returnText = `<button class="btn btn-xs btn-warning" > <i class="fa fa-edit" ></i></button>`;
                            $(returnText).on('dxclick', function () {
                                //DataEdit(options.data.BankID, options.data.BankName, options.data.CompanyID, options.data.Abbreviation,);
                            }).appendTo(container);

                            var returnText = `<span>&nbsp</span><button class="btn btn-xs btn-danger" > <i class="fa fa-trash"></i></button>`;
                            returnText = returnText + '</div>';
                            $(returnText).on('dxclick', function () {
                               // DataDelete(options.data.BankID);
                            }).appendTo(container);


                        },
                    },
                ],

                //  groupPanel: { visible: true },

                height: 520,

            }).dxDataGrid("instance");
        }
        function saveSuccess(data) {
            debugger
            if (data.result == 1) {
                $.alert.open({
                    type: 'Success',
                    content: data.message,
                    callback: function () {
                        Clear();
                        GetCBMBankAccountList();
                    }
                });
            }
            else {
                $.alert.open("error", data.message);
            }
        }
        function Clear() {
            $("#AccTypeID").val('');
            $("#BankID").val('');
            $("#BranchID").val('');
            $("#CurrencyID").val(1);
            $("#AccountNumber").val('');
            $("#Name").val('');
            $("#Designation").val('');
            $("#PhoneNumber").val('');
            $("#FaxNumber").val('');
            $("#Email").val('');
            $("#Comments").val('');
        }
    </script>
}